---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# rhel8u7-securityfix-20230705
# https://console.redhat.com/insights/remediations/8b5babc2-502f-415e-8085-ab5834d33338
# Generated by Red Hat Insights on Wed, 05 Jul 2023 10:44:29 GMT
# Created by tpicapunix

- name: run insights to obtain latest diagnosis info
  hosts: hostlist
  vars:
    insights_remediation: " 8b5babc2-502f-415e-8085-ab5834d33338"
    insights_signature_exclude: "/hosts,/vars/insights_signature,/vars/insights_remediation"
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRblZqZG5jMU9FUXJhalZ3VGtGUmFtRkdVa0ZCYTBSVWNu
      UnZRVzFSVkRBdlFVODVaRlJyYlRablJHZHRabUkyVGxGMGFVNEtPWHBNYmtWcmRsaEpibVZQV2s0
      MWRGcDBPSEZWWmtaaFNYQnBSMEV5SzFGWU9GVlNaR2hWTDJOdmRIbDRLMWQ2UlZscU1sSlpaSEEz
      ZEVnM01IQXpWUXBpWjFwbVRGRTNkV2wxYm5NNGIwMXFaV3N5VURaVFVWcExXRmxhV1c0NVYyZENP
      V2R2VG5FMk9FZERXbXR3Um1KVFVqWXJTRVl3TWxwYVVUUlZTV0ZtQ21Ga05XSmplWElyZVVwbFoy
      TlFVVk5RYUhscmNtaGtaV1pQWm5ORk9YUlhlVmhXUjFwSk1ETnNXSGh3VEVaSlJsQlFZWFZRUzNB
      NE5WcHBha0Y0VjNvS2RHYzRTSGRGUjJzME5HRTFRa3BqYVdsdWQyNXJWV1pDVEc0NFVHeHVPRVF2
      TjNSc1NsZExUVWh4TmtsWVkwMW1NVzlVU1RKdWMzZDFXRkZzTUhsbWRRcHNUekYwVHpkWFpHVTJO
      QzlHT0dGdVptNVpUVUZ5TjNoamIxTTJaMU5sTDJWeWRuVnZOamt3YVVOWFYyWm5SV294WVhSd1Qx
      cDJjazF5YmxkSllYUlhDakZrYUVONFVqaGFabkE1UmxsQ2RXUnhZV05yYVhGWVNtNDBjbEppTTFo
      clFVWlNUVmQ0YTBseWJFVkdkRUZKYjJveVdrNDJabGRVYjJwQ1JVTmlRbmNLZG14RmQxWmxObGhR
      ZW5WYWVVRm9Sa0ZFZGxWcU1UZElLME01VnpCd1ZrcHlkM3BSVUV0cE1DOXJlRTFOZVV0UWJ6ZDNa
      R3BEU0dsalFtdHRRVk01TXdwR1ZYbzVUMWcxY0RRNFpIa3lhV1p6TDBOblIyMW5XWFZEWjI1UllW
      QjNWMkpHTUhkMGREQmlWVk55WldkUldWZ3JkV3hJTlhOQlJtMW9TVUZ1Ym1GdENsTkNWVUV5ZFZr
      MVpsZGlPVXhzTmpablIwcGlUSGxNY1ZSUVNFcFNTbWxXWjNKTEt6VnpTMHgyZDNnMmNqTXJjVnBr
      YTFoUVIza3hSM0ZTVlZKT1NGUUtXWFoxVm5sUGRIZHZVV2xCUm1rdlJYWmxPV05xV2xwdWEwcDVW
      MlZUV1RodVVtNDFlbll5TkhSUWJGSkdVVk5xZWtscWMxSlNhVVJvYzA1UWFGUlRhd3AxZGxkYVdI
      SjBWVlpoUlQwS1BVMDNMek1LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  become: true
  tasks:
    - name: obtain diagnosis info
      command: "insights-client --diagnosis{{ insights_remediation | regex_search('\\s[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}') }}"
      register: insights_result
      changed_when: false
      check_mode: false
    - name: register insights report as fact for use by other plays
      set_fact: insights_report={{ insights_result.stdout }}

# The audit service does not generate any events with "exit" filter rules on RHEL 8.7 and 9.1 systems
# Identifier: (advisor:audit_not_log_with_exit_filter|AUDIT_EXIT_FILTER_NOT_LOG_WARN,fix)
# Version: 45131bbd76ab2ff7a59d9ad5f9326463a3d14b87
- name: Update kernel to the latest
  hosts: "sng1lx0099.corp.ad.tullib.com"
  become: true

  vars:
    kernel_pkg: "{{ 'kernel-rt' if 'rt' in ansible_kernel else 'kernel' }}"
    pydata: "{{ insights_report.details['audit_not_log_with_exit_filter|AUDIT_EXIT_FILTER_NOT_LOG_WARN'] | default('') }}"

    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldrbzFkV0ZqZG5jMU9FUXJhalZ3VGtGUmFWcDVRUzh2VTJkb1lu
      UmxWelZTYUZWemNIaE9PRmR6VUV0UU1HUndPRk5FTTNWNmVVa0tjV1owWkdwclMwVTFiWEZzTkd0
      NGRGaFJielJRVDFCb1pGa3paSGR1VGpSWlVuVlVVbmRRTDJoaFVrMXZla1owV2tkbFRHWk9TR1Zo
      TlVwWVRYaFlUZ3BNYldWSlJHcDZibGRDT1Zac05WTkpRMGhUYTA1WFJsZE5ZMFEySzNaMGJ6Qkhk
      R3hwWVVKMFJVaFJObkp5V2xOVU5XeElkMUpsYm5WWE9EaEViRmwzQ2pKd2FrTm5PVWczV0dSeGFF
      bzRTRVl6TkdkcGRFMUVTMlk0YUM5SFR5dE1kVWx0ZVZOTlJERk1NVlZSWmtrelRFcERWMHB2VDBV
      eFlUTnFiMWQwU1hBS2FuVk1Oa1JNY0dwSFNTOHhZakZ0WW5wRFVucExMMlZ3VGtaVFV5dDJTWEZx
      U1ZCR1RWSjRiMHB3YUdGclVrcHdPVFo0T0hFeFYzaHVSa3hZYjFkYUt3b3ljaTlNY1VoR0t6ZFFV
      bWcwTkhNd1dVTnpkRU0wVjJKYU9IQktPVEI1TlhFek5IWm9SVk5oYldwWlp6SnJjVVJ1YzJ4NGRW
      VmpiRmg2U2xGRllXeHRDbHBGTkhwWU1FVnFLMXBYTTJReGRubGxORFkzU0c1NWR6UXlRVk5EVUcx
      dFpXUk9ZMjFUWkVGM1RsTmlZVVIxUkhvdlYzcGxObUpCUTBWSk1GaFZUMG9LYkVWdE5XRkxlbU5w
      Y1RJcmR6WkRORTVvVlhFMU4wRlBkalJTWjB4SGVVNVVZbEJ2UVdOSlFXUnNkMUppYlVSRlZtMU5k
      VGN2ZVZaMk9IZDVjekJITmdwUVZHWkZOemRPTmxGSVRubGhVa2xLZFRGRE1WWXdhbWxpYUhFemQy
      OVJZME01TXpOU2NUVnNXVkZaYkhkaFNuUXZWMll5VGt0eFpVMDFVakpuYjJrM0NpdFJRVE14VURs
      UlRucDRhalEyVFhScWNHOVNTRmRsY2pBNE1sWXlNbWw1VFhNeVNHeHpVV3hZVFVZM2EwVkpabXhM
      UjBzeWNVSlZObWxHUmxoaFYyZ0tVRmxrYUdkUEwyczBRVmwyUms4MksyaHBVMVJNTkdocGJqRk1V
      Rzk0Y0ZCck1YUktWbE5OTkVGSlluSTRaM2hyV1V0bWRHUktOVmR3UTJWNlozVkRSQXBLWW5RM0sw
      RTRPVzAwU1QwS1BWWnNSeThLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - when: pydata != ''
      block:
        - name: Unlock RHSM release-set ONLY when cannot fix the issue within the current release-set
          when:
            - pydata.cur_lock is defined
            - pydata.rcm_locks is defined
          command: subscription-manager release --unset

        - name: Enable the RHEL base channel if necessary
          command: subscription-manager repos --enable="{{ pydata.no_base }}"
          when: (pydata.no_base is defined) and ((pydata.cur_lock is not defined) or (pydata.cur_lock is defined and pydata.rcm_locks is defined))

        - name: Enable the required channel "{{ pydata.req_repos[0] }}" to fix in the current release-set
          command: subscription-manager repos --enable="{{ pydata.req_repos[0] }}"
          when:
            - pydata.cur_lock is defined
            - pydata.rcm_locks is not defined
            - pydata.req_repos is defined

        - name: Clear and update repos
          command: yum clean all
          register: yum_clear
          changed_when: '"Cleaning up everything" in yum_clear.stdout'

        - name: Update kernel
          yum:
            name: "{{ kernel_pkg }}"
            state: latest
          register: yum

        - when: yum is changed
          name: set reboot fact
          set_fact:
            insights_needs_reboot: true

        - when: not yum is changed
          block:
            - name: get latest installed {{ kernel_pkg }} package version
              shell: rpm -q {{ kernel_pkg }} --queryformat="%{buildtime}\t%{version}-%{release}.%{arch}\n" | sort -nr | head -1 | cut -f2
              register: latest_kernel
              check_mode: no

            - name: get configured default kernel
              command: /sbin/grubby --default-kernel
              register: default_kernel
              check_mode: no
              changed_when: false

            - when: default_kernel.stdout.split('-', 1)[1] != latest_kernel.stdout
              name: set the default kernel to the latest installed
              command: /sbin/grubby --set-default /boot/vmlinuz-{{ latest_kernel.stdout }}
              register: grub_change
              check_mode: no
              changed_when: grub_change.rc == 0

            - when: grub_change is changed
              name: set reboot fact
              set_fact:
                insights_needs_reboot: true


# Reboots a system if any of the preceeding plays sets the 'insights_needs_reboot' variable to true.
# The variable can be overridden to suppress this behavior.
- name: Reboot system (if applicable)
  hosts: "sng1lx0099.corp.ad.tullib.com"
  become: true
  gather_facts: false
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRMVk0ZG5jMU9FUXJhalZ3VGtGUmFrMUVRa0ZCYTJOeE1W
      WlhVbEF3VUVoMGRIRjBWMGt4UkZSdU4zcE1kbFUyU0hKd2QxSUtUbkJ3Um5SWGJWRktiM2xxYm1w
      bE5XUmFSemMxUTNCU1kzZGFPRU5XVW5sRlRVRXpVREExZW1Kc1UzSnFWbTUxVW5oNlpVeG1SbTFy
      YW1SRVJWcHdjZ3ByWTJ0d2FFazJSVUpIYWtJemEyaGFUalJ5YTNwUWRWQm1PR1pMUVdsSE1ESmxk
      SGhXVFZWV01tZHRkV3c0UjBJMmRIcEpkRk5uVFRGQlFYQkdORTFRQ2s1NFRDOUpUMlY2ZFdRMGFt
      VlFaV05KZWpGS1dtMTVkVGgzWTNoVFZqWkpTbTVPU1VGSGVHYzVWRUpVYzNNMFEwbHVaVlZXY0RG
      VWRrUlFPUzlHVXk4S2VGaFlaMFphWlM5VlZuQjBaRzA1ZDJkbmRVOXRiR2hvWVZCTVZHNU5Tbkoy
      UVRsV2FVUnZRVzV2WWt0b1VIbEtZMHBSYjJOTFdrRlRjVTF6ZWs1VWNncHVNek5JYlRoUk9IQnRW
      VTFLYldobU9VRnZkM2x4VW5GWVVHeHpXVGwzT0UxRU1WQkZjR3htY2pJeVlYTjFMMHhvYjNGNlIz
      TmtOMUUxTTJwdFMyNXBDaXM1Y0VjeWEzVkNSVXhpVVhoblRHcERiVlZsUzFCdmJuaFhjM0JuVFZs
      M2VYQjFaVFJvYnl0dmFsZG5WRGR2ZG1GbFRFNVRTMkV2UkZOS2JEWldRaThLZEd4YUwxUXJPRFZr
      Ym5ZclNWb3phbEJTZFM5bVpuZFBkVVpVV2xoNmVGTkJUalZSV1M5ak15c3hhbUZSTDBKeFdYTmhi
      M2RpUkZreGRXUXZVeXRsYVFwa2FEa3JWRkV5TlVKa1NYa3hibGh3ZWpoV1JHbHpjbEp3Y0VrNWFs
      SldWakkwTVVVelRVWkhka1ZaTm1aVFYzSlZWMWMzY0RKbFpUbGphelpOVlUweUNrNUZjRXBLWm5G
      UFNFdHBjRXRPZVRKdVFVRTJURmcxTHpNeGFWSk9VSEZZVXpKRVdqSlpkbVZTUTJOMmVDOHZPVTlo
      UzFWd1FsZElZVmxYYW5STU4wWUtSWFJWVEZGeFZESkJPVTF3WjFSU1RtOU5WbEZ4Y1haQ01GUlBP
      WE00TmxoTmRuUkdRa1IzYW5SbWIxSm9NRnBEYlUwME1FRlhRMHBxT0RKNlduTlRZUXBCYXpkUEsy
      UkpkMFl5VVQwS1BWcEtiallLTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - when:
        - insights_needs_reboot is defined
        - insights_needs_reboot
      block:
        - name: Reboot system
          shell: sleep 2 && shutdown -r now "Ansible triggered reboot"
          async: 1
          poll: 0
          ignore_errors: true

        - name: Wait for system to boot up
          local_action:
            module: wait_for
            host: "{{ hostvars[inventory_hostname]['ansible_host'] | default(hostvars[inventory_hostname]['ansible_ssh_host'], true) | default(inventory_hostname, true) }}"
            port: "{{ hostvars[inventory_hostname]['ansible_port'] | default(hostvars[inventory_hostname]['ansible_ssh_port'], true) | default('22', true) }}"
            delay: 15
            search_regex: OpenSSH
            timeout: 300
          become: false

- name: run insights
  hosts: "sng1lx0099.corp.ad.tullib.com"
  become: true
  gather_facts: false
  vars:
    insights_signature_exclude: /hosts,/vars/insights_signature
    insights_signature: !!binary |
      TFMwdExTMUNSVWRKVGlCUVIxQWdVMGxIVGtGVVZWSkZMUzB0TFMwS1ZtVnljMmx2YmpvZ1IyNTFV
      RWNnZGpFS0NtbFJTVlpCZDFWQldVaHBRaXR6ZG5jMU9FUXJhalZ3VGtGUmFXdDRaeTh2WmtaRFoz
      QXlTblIxVEd0UU5qQnNTa3BZYm1GU1JGTjVjVVYwU0ZSNlRGY0tOVlZSVlc5MWEyUmpVRFJVUlZn
      d01EaDFhRkJHUzFaSmVrdFVTR2RsYTFOaU1UUXlkMjlQYm5sR2VUUnpRbEJrZEZoaGREVlliWEp0
      VGxsR1EwaEVWZ28xYVhSdlNrcDBPVzg1UWtkQlJVaDVZMFJ3SzBoNVNqWXphM0paZVRGUk1rOXVU
      azF3VjJaSmNtYzJUakJXVTJoa1JtVk1lR0ppTjBaMlpFaEpjbFo2Q2pJNGFrdHhOemx1Tm13eUx6
      aDZZVkJSTDFkWVZIWkNaMDVhUkVWTFJ6TmhSSFl3WVRkbWIyUnlPRWhEZGxseE5tNUhNRkZOY1RO
      U1ZFOXBkbFZtTTFnS1JuQnlhVTh2TDNKSlRDOVlSelE1TTA1NGFWSjBRakVyZEhSUk0wZHNhM1ZE
      ZFVwck1EQkdaREp0ZDNZNFprRnZaR2xUUW5aelQydEpZekZyV25adFN3cEJjR3BEY1ZKMWVHaExU
      MDgzYWxZM1FYSnRTV0p6TkhobVJrUkJVMkZaV2t4R01VMHZhME42ZWs1d1MwTjFhbE5hVUUxRlVt
      WlhhV2RHVGpGMWRqRjNDalpQSzB0b1pTdFJVRU5hUm5CV1kwVndSbTFSTVdwcWFrOVFPV2haSzNW
      alZWSnhSVEkyTlhGTWRuWnFSWE4wUW5WQk4xQkZNRVZ3UkRsaU5VaFZSM1lLTkZKemJXc3pNbFpC
      Vnl0WE5IWk1VRWQwZG1sQ00wSXpUbE0wZUhCdVIzSmlObGs1Y1cwNFZuVTJSRUZIV2xOYWRsbFlk
      bWQwTm1WR2N6RTVTVFZZUWdvMGVtcFVSRUlyTW1sT2NrcE9jM2d5YURoU1VGVnJMMmhZUzFKMGEy
      WnZZMlpKZVRkcGNWY3hiMGRsTlZSMmFqTTFSbXRqUld0YU9VRnpSMjl6WXpWMENuUlZkVlZJWWpS
      ME5EVTFSSE5EWlZWc1ZEZFNOakJDTTB4d1Z6TmlTRTF0YzFCMEx6RktNRFEwYm1KS2RFTkhUM1Jy
      UVVWWVRsVTJlbGxUTDNBMFFqSUtaSFYxY2tZdlNHUnFWWFJNVDNSdlNFTnlZVWd2WkZwaFRVNTZk
      MVZpZUc1VFZXUkdZU3R6TTBaNFJHczFVVkU0VVRaMVVucFpRbWw0WkcxeWREZGpUQXBKYTA1NlEy
      aHBRMDlrY3owS1BVMVZOMk1LTFMwdExTMUZUa1FnVUVkUUlGTkpSMDVCVkZWU1JTMHRMUzB0Q2c9
      PQ==
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false
