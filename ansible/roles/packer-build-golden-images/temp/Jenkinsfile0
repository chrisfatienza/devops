def label = "mypod-${UUID.randomUUID().toString()}"

properties(
  [parameters(
    [
    choice(choices: ['AWS', 'VMware'], description: 'Please select the Hypervisor', name: 'Hypervisor'),
    choice(choices: ['Windows', 'Linux'], description: 'Please select Operating System', name: 'OS'),
    choice(choices: ['Windows_Server-2019-English-Full-Base', 'Windows_Server-2019-English-Core-Base', 'Windows_Server-2016-English-Full-Base', 'Windows_Server-2016-English-Core-Base', 'Windows_Server-2012-R2_RTM-English-64Bit-Base', 'Windows_Server-2012-R2_RTM-English-64Bit-Core', 'Amazon_Linux_2_LTS', 'RHEL_7.6'], description: 'Please select your OS distribution', name: 'Distribution')
    ])
  ]
)
podTemplate(label: label, containers: [
    containerTemplate(name: 'ansible', image: '627822851775.dkr.ecr.eu-west-1.amazonaws.com/cloudbees:ansible', command: 'cat', ttyEnabled: true)
  ],
    annotations: [
    podAnnotation(key: 'iam.amazonaws.com/role', value: 'k8s-eks-mgmt-role')
    ,]
  ) {
  node(label) {
    checkout scm
    container('ansible')
        {
        stage('Setup Docker container') {
                sh '''
                apt-get install git -y
                git version
                ansible --version
                aws sts get-caller-identity
                '''
            }
        stage('Verify Template configuration') {
                sh '''
                export USER=root
                packer validate -only=$Distribution $Hypervisor-$OS-packer.json
                '''
            }
        stage('Get AWS accounts') {
                sh '''
                ls -la | grep accounts
                cat accounts
                myVar=$(cat accounts)
                echo "${myVar}"
                echo $myVar
                export value2="${myVar}"
                echo $value2
                '''
              }
        stage('Build Golden Images')
            {
                sh '''
                export USER=root
                packer build -only=$Distribution $Hypervisor-$OS-packer.json
                echo "completed"
                '''
            }
        }
    }
}
